# ThreadLocal

- 해당 쓰레드만 접근할 수 있는 저장소
- 일반적인 변수 필드의 경우 여러 쓰레드가 같은 인스턴스의 필드에 접근하면 다른 쓰레드에서 저장한 값이 사라질 수 있다.
- 쓰레드 로컬을 사용하면 쓰레드마다 별도의 내부 저장소를 제공한다. 따라서 여러 쓰레드에서 같은 인스턴스의 쓰레드 로컬 필드에 접근해도 문제가 없다.
- 쓰레드 로컬은 `java.lang.ThreadLocal` 클래스를 사용하면 된다.

# 사용법

- 쓰레드 로컬 필드 사용

```java
public class ThreadLocalService {
	private ThreadLocal<String> nameStore = new ThreadLocal<>();
    // private String nameStore;	// ThreadLocal을 사용하지 않는 경우
}
```

- 값 저장

```java
nameStore.set("kim");
```

- 값 조회

```java
nameStore.get();
```

- 값 삭제

```java
nameStore.remove();
```

# 주의사항

- 쓰레드에서 쓰레드 로컬을 다 쓰고 나면 `ThreadLocal.remove()`를 사용해서 쓰레드 로컬에 저장된 값을 꼭 제거해줘야 한다. WAS처럼 쓰레드 풀을 사용하는 경우, 쓰레드 로컬의 값을 제거하지 않으면 문제가 발생할 수 있다.

**문제 상황**

1. HTTP 요청이 오면 WAS는 쓰레드 풀에서 쓰레드 하나를 조회하여 할당한다.
2. 할당받은 쓰레드가 쓰레드 로컬에 값을 저장한 후, 클리어 하지 않은 채로 HTTP 응답이 종료된다.
3. WAS가 해당 쓰레드를 쓰레드 풀에 반환한다.
4. 새로운 HTTP 요청이 와서 WAS가 쓰레드 풀에서 쓰레드 하나를 조회하여 할당한다. (쓰레드를 생성하는 비용이 비싸기 때문에 쓰레드를 제거하지 않고 보통 쓰레드 풀을 통해 쓰레드를 재사용한다.)
5. 할당된 쓰레드에서 쓰레드 로컬의 값을 조회하는데 이전 쓰레드 로컬의 값이 제거되지 않고 남아 있는 경우, 이전에 저장했던 데이터를 조회하게 된다.
